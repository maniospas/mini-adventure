<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mini Adventure</title>
<style>

    body {
        font-family: sans-serif;
        background: #111;
        color: #eee;
        padding: 20px;
    }
    .star-icon {
        color: gold;
        width: 20px;
        height: 20px;
    }

    #floatingMessage {
        position: fixed;
        top: 140px;
        left: 300px;
        /* background: rgba(40,40,40,1.00); */
        border-radius: 12px;
        /* border: 2px solid #666; */
        padding: 20px 60px;
        color: #eee;
        font-size: 28px;
        text-align: center;
        z-index: 9999;
        height: 250px;
        min-width: 350px;

        opacity: 0;
        pointer-events: none;

        transition: opacity 0.4s ease;
    }
    #floatingMessage.show {
        opacity: 1;
    }

    #floatingOverlay {
        background: rgba(0,0,0,0.65);
        z-index: 9990;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    #floatingOverlay.show {
        opacity: 1;
        visibility: visible;
    }
    #newgame {
        float: right;
        margin-left: 5px;
        padding: 6px 10px;
        background: #533;
        border: 1px solid #555;
        border-radius: 6px;
        cursor: pointer;
        color: #eee;
    }
    #newgame:hover {
        background: #644;
    }
    #choices {
        display: flex;
        justify-content: center;
        overflow: visible;
    }


    .card-btn,.ledger-card  {
        font-family: sans-serif;
        display: block;
        position: relative;
        transition: opacity 0.4s ease, transform 0.4s ease;
        padding: 15px;
        margin: 20px;
        border: 1px solid #555;
        color: black;
        background: #999;
        cursor: pointer;
        border-radius: 8px;
        width: 220px;
        text-align: center;
        line-height: 1.3em;
        height: 280px;
        animation: cardEnter 0.35s ease-out;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    @media (max-height: 768px) {
        .card-btn,.ledger-card {
            margin-left: 10px!important;
            margin-right: 10px!important;
            margin-top: 5px!important;
        }
        #floatingMessage { 
            transform: scale(0.85);
            transform-origin: top center;
            left: 200px;
            top: 125px;
        }
        #choices {
            transform: scale(0.85);
            transform-origin: top center;
        }
        #ledger-container {
            transform: scale(0.85);
            transform-origin: top center; /* optional but makes scaling look nicer */
        }
    }

    .card-btn[data-stars="1"] {
        box-shadow: 0 0 8px 2px rgba(0,255,140,0.25);
    }
    .ledger-card[data-stars="1"] {
        box-shadow: 0 0 8px 2px rgba(0,255,140,0.25);
    }

    /* Difficulty 2 ‚Äì yellow glow */
    .card-btn[data-stars="2"] {
        box-shadow: 0 0 10px 3px rgba(255,255,120,0.35);
    }
    .ledger-card[data-stars="2"] {
        box-shadow: 0 0 10px 3px rgba(255,255,120,0.35);
    }

    /* Difficulty 3 ‚Äì orange glow */
    .card-btn[data-stars="3"] {
        box-shadow: 0 0 12px 4px rgba(255,150,60,0.45);
    }
    .ledger-card[data-stars="3"] {
        box-shadow: 0 0 12px 4px rgba(255,150,60,0.45);
    }

    /* Difficulty 4 ‚Äì red/purple legendary glow */
    .card-btn[data-stars="4"] {
        box-shadow: 0 0 14px 6px rgba(255,60,120,0.55),
                    0 0 30px 10px rgba(170,0,255,0.25);
    }
    .ledger-card[data-stars="4"] {
        box-shadow: 0 0 14px 6px rgba(255,60,120,0.55),
                    0 0 30px 10px rgba(170,0,255,0.25);
    }
    @keyframes cardEnter {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.96);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .card-btn:hover {
        transform: translateY(-6px) scale(1.03);
        box-shadow: 0 12px 18px rgba(0,0,0,0.45);
    }
    .card-btn:hover {
        background: #aaa;
    }
    .card-btn:hover div[style*="font-size:64px"] {
        animation: pulse 0.6s infinite alternate;
    }
    .card-btn:active {
        transform: scale(0.95);
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .ledger-card:active {
        transform: scale(0.95);
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* Sparkle container */
    .sparkling {
        position: relative;
        overflow: visible;
        z-index: 1;
    }

    .sparkling::before,
    .sparkling::after {
        content: "‚ú®";
        position: absolute;
        font-size: 20px;
        opacity: 0;
        animation: sparkleFloat 2.4s infinite ease-in-out;
        pointer-events: none;
    }

    /* Left sparkle ‚Äî now inside card edge */
    .sparkling::before {
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        animation-delay: 0.2s;
    }

    /* Right sparkle ‚Äî symmetric and balanced */
    .sparkling::after {
        right: 15px;
        top: 35%;
        transform: translateY(-50%);
        animation-delay: 1s;
    }
    .sparkling div[style*="font-size:64px"] {
        filter: drop-shadow(0 0 8px gold)
                drop-shadow(0 0 12px gold);
    }

    /* -----------------------------------------
   ENCOUNTER EFFECTS: Threat Pulse + Shake
   ----------------------------------------- */

    .encounter-card {
        position: relative;
        transition: transform 0.15s ease;
    }

    /* Shake on hover */
    .encounter-card:hover {
    }

    @keyframes shake {
        0%   { transform: translate(0px, 0px); }
        25%  { transform: translate(1px, -1px); }
        50%  { transform: translate(-1px, 1px); }
        75%  { transform: translate(1px, 1px); }
        100% { transform: translate(0px, 0px); }
    }

    /* ----- Difficulty-based pulse intensities ----- */

    @keyframes pulseEasy {
        0%   { box-shadow: 0 0 0px rgba(255,60,60,0.0); }
        50%  { box-shadow: 0 0 8px rgba(255,60,60,0.4); }
        100% { box-shadow: 0 0 0px rgba(255,60,60,0.0); }
    }
    @keyframes pulseMedium {
        0%   { box-shadow: 0 0 0px rgba(255,40,40,0.1); }
        50%  { box-shadow: 0 0 12px rgba(255,40,40,0.6); }
        100% { box-shadow: 0 0 0px rgba(255,40,40,0.1); }
    }
    @keyframes pulseHard {
        0%   { box-shadow: 0 0 0px rgba(255,20,20,0.1); }
        50%  { box-shadow: 0 0 18px rgba(255,20,20,0.8); }
        100% { box-shadow: 0 0 0px rgba(255,20,20,0.1); }
    }
    @keyframes pulseDeadly {
        0%   { box-shadow: 0 0 0px rgba(255,0,0,0.2); }
        50%  { box-shadow: 0 0 26px rgba(255,0,0,1); }
        100% { box-shadow: 0 0 0px rgba(255,0,0,0.2); }
    }

    .floating-text {
        opacity: 0;
        transform: translateY(10px);
        animation: floatIn 0.3s ease forwards;
    }

    @keyframes floatIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .floating-text.out {
        animation: floatOut 0.2s ease forwards;
    }

    @keyframes floatOut {
        to {
            opacity: 0;
            transform: translateY(-10px);
        }
    }

    /* classes applied dynamically */
    .encounter-diff-1 { animation-name: pulseEasy; }
    .encounter-diff-2 { animation-name: pulseMedium; }
    .encounter-diff-3 { animation-name: pulseHard; }
    .encounter-diff-4 { animation-name: pulseDeadly; }

    .card-fade-out {
        opacity: 0;
        transform: scale(0.8);
        transition: opacity 0.45s ease, transform 0.45s ease;
        pointer-events: none;
    }
    .card-zoom {
        position: relative;
        z-index: 999;
        transform: scale(1.2);
        transition: transform 0.45s ease, opacity 0.45s ease;
    }
    .card-zoom-fade {
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .card-effect-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 34px;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 0 8px black;
        opacity: 0;
        animation: overlayPop 0.8s ease forwards;
        pointer-events: none;
    }
    @keyframes overlayPop {
        0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.6); }
        30%  { opacity: 1; transform: translate(-50%, -50%) scale(1.25); }
        60%  { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        100% { opacity: 0; transform: translate(-50%, -60%) scale(1); }
    }
    @keyframes pulse {
        from { transform: scale(1); }
        to   { transform: scale(1.30); }
    }
    #choices {
        margin-bottom: 20px;
    }
    #log {
        background: #111;
        padding: 10px;
        height: 260px;
        overflow-y: auto;
        border-radius: 6px;
        white-space: pre-line;
        font-size: 14px;
        display: none;
    }
    .stat-block {
        margin-bottom: 8px;
    }

    /* -----------------------------
       Fancy modal styling
       ----------------------------- */
    .modal-backdrop {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease, visibility 0.4s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }
    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    .modal {
        background: #333;
        padding: 20px;
        border-radius: 8px;
        width: 340px;
        max-width: 90vw;
        text-align: center;
        transform: scale(0.8);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .modal-backdrop.show .modal {
        transform: scale(1);
        opacity: 1;
    }
    .modal button {
        margin-top: 15px;
        padding: 8px 14px;
        border: 1px solid #666;
        border-radius: 6px;
        background: #444;
        cursor: pointer;
        color: #eee;
    }
    .modal button:hover {
        background: #555;
    }
    #topbar {
        float: right;
        text-align: right;   /* keeps score aligned under buttons */
    }

    #buttons {
        display: flex;
        justify-content: flex-end;
        gap: 5px;
    }

    #adventureDisplay {
        margin-right: 10px;
        color: #1f1f1f;
        text-align: center;
        float: left;
    }

    /* Move modals to the top on mobile */
    @media (max-width: 600px), (max-height: 700px) {
        .modal-backdrop {
            align-items: flex-start !important;
            padding-top: 20px;        /* space from the top */
        }
        .modal {
            margin-top: 0 !important;
        }
    }

    #main-menu {
        position: fixed;
        inset: 0;
        background: #111;
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        transition: opacity 0.4s ease, visibility 0.4s ease;
    }

    #main-menu.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .menu-btn {
        padding: 14px 28px;
        margin: 10px;
        background: #333;
        color: #eee;
        border: 2px solid #666;
        font-size: 22px;
        border-radius: 10px;
        cursor: pointer;
        width: 260px;
        transition: transform 0.15s ease, background 0.2s;
    }

    .menu-btn:hover {
        background: #444;
        transform: scale(1.05);
    }

    body.game-hidden #topbar,
    body.game-hidden #stats,
    body.game-hidden #choices,
    body.game-hidden #log {
        display: none !important;
    }



</style>
</head>

<body>



<div id="main-menu">
    <h1 style="font-size:42px; margin-bottom:20px;">Mini Adventure</h1>

    <button class="menu-btn" onclick="startNewGameFromMenu()">New</button>
    <button class="menu-btn" id="continue-btn" onclick="continueGame()">Continue</button>
    <button class="menu-btn" onclick="openCardSearch()">Ledger</button>

    <p style="margin-top:30px; opacity:0.6;">pre-alpha</p>
</div>


<div id="topbar">
        <button id="newgame" onclick="returnToMenu()">X</button><br>
        <!--<button id="asceticBtn" onclick="openAsceticModal()">Ascetic (+5 üèîÔ∏è)</button>-->
</div>


<div>
<div id="adventureDisplay">0 üèîÔ∏è</div>
<div id="stats"></div>
</div>

<hr>

<div id="choices"></div>
<div id="log"></div>

<!-- Restart modal -->
<div id="modal-newgame" class="modal-backdrop">
    <div class="modal">
        <h2>Restart?</h2>
        <p>This will abandon current progress.</p>
        <button onclick="confirmNewGame()">New adventure</button>
        <button onclick="closeNewGameModal()">Cancel</button>
    </div>
</div>

<!-- Death modal -->
<div id="modal-death" class="modal-backdrop">
    <div class="modal">
        <h2>üíÄ Fallen!</h2>
        <p id="death-score"></p>
        <button onclick="forceNewGame()">Leave</button>
    </div>
</div>

<div id="modal-death-adv" class="modal-backdrop">
    <div class="modal">
        <h2>üíÄ Lost interest!</h2>
        <p id="death-score-adv"></p>
        <button onclick="forceNewGame()">Leave</button>
    </div>
</div>

<script>
let logLines = [];

function preloadImages(files, callback) {
    let loaded = 0;

    files.forEach(src => {
        const img = new Image();
        img.onload = img.onerror = () => {
            loaded++;
            if (loaded === files.length) callback();
        };
        img.src = src;
    });
}

// Show/hide continue button depending on save existence
window.addEventListener("load", () => {
    const raw = localStorage.getItem("tama_save");
    if (!raw) {
        document.getElementById("continue-btn").style.display = "none";
        return;
    }
    try {
        const data = JSON.parse(raw);
        if (!data.adv || data.adv.hp <= 0) {
            document.getElementById("continue-btn").style.display = "none";
        }
    } catch (e) {
        // Invalid save ‚Üí hide continue
        document.getElementById("continue-btn").style.display = "none";
    }
});


/* --- MENU HANDLERS --- */

function returnToMenu() {
    saveGame();
    document.getElementById("main-menu").classList.remove("hidden");
    document.body.classList.add("game-hidden");
}

function hideMainMenu() {
    document.getElementById("main-menu").classList.add("hidden");
}

function startNewGameFromMenu() {
    document.body.classList.remove("game-hidden");
    hideMainMenu();
    localStorage.removeItem("tama_save");
    adv = createNewAdventurer();
    adv.Tough = adv.hp;
    statlessMode = false;
    logLines = [];
    generateChoices();
    updateStats();
    saveGame();
}

function continueGame() {
    document.body.classList.remove("game-hidden");
    hideMainMenu();
    generateChoices();
    updateStats();
}

function openCardSearch() {
    buildLedgerList();
    document.getElementById("main-menu").style.display = "none";
    document.getElementById("ledger-screen").style.display = "flex";
}
function closeLedger() {
    document.getElementById("ledger-screen").style.display = "none";
    document.getElementById("ledger-list").innerHTML = "";  // <-- FIX
    document.getElementById("main-menu").style.display = "flex";
}

function allCardsFlat() {
    return [
        ...encounters.map(c => ({...c, type:"Encounter"})),
        ...trainings.map(c => ({...c, type:"Training"})),
        ...treasures.map(c => ({...c, type:"Treasure"})),
    ];
}

function buildLedgerList() {
    const listEl = document.getElementById("ledger-list");
    listEl.innerHTML = "";
    const seen = encounteredCards;
    const search = document.getElementById("ledger-search").value.toLowerCase();
    const pool = [];
    encounters.forEach(c => pool.push({ type: "enc", card: c }));
    trainings.forEach(c => pool.push({ type: "train", card: c }));
    treasures.forEach(c => pool.push({ type: "treas", card: c }));
    const filtered = pool.filter(entry => {
        if (!seen.has(entry.card.name)) return false;

        const hay = (entry.card.name + " " + (entry.card.flavor || "") + " " + (entry.card.stat || "")).toLowerCase();
        return hay.includes(search);
    });
    if (filtered.length === 0) {
        listEl.innerHTML = `<p style="opacity:0.7">No matching cards.</p>`;
        return;
    }
    filtered.forEach(entry => {
        const div = document.createElement("div");
        div.className = "ledger-card";
        div.style.cursor = "default";
        div.innerHTML = cardButtonHTML(entry);
        div.onclick = null;
        if (entry.type === "enc") div.dataset.stars = encounterIntensity(entry.card.dc);
        else div.dataset.stars = entry.card.difficulty;
        listEl.appendChild(div);
    });
}



let encounteredCards = new Set();


// ----------------------------------------------------
// LocalStorage helpers
// ----------------------------------------------------
function saveGame() {
    const state = JSON.stringify({
        adv,
        statlessMode,
        Backgrounds: adv.Backgrounds,
        logLines,
        encounteredCards: [...encounteredCards],
    });
    localStorage.setItem("tama_save", state);
}

function loadGame() {
    const raw = localStorage.getItem("tama_save");
    if (!raw) return false;

    try {
        const data = JSON.parse(raw);
        adv = data.adv;
        adv.Backgrounds = data.Backgrounds || [];
        statlessMode = data.statlessMode || false;
        logLines = data.logLines || [];
        encounteredCards = new Set([
            ...encounteredCards,
            ...(data.encounteredCards || []),
        ]);
        return true;
    } catch(e) {
        return false;
    }
}

function getTraitBonuses() {
    const b = adv.Backgrounds || [];
    const bonuses = {
        Strong: 0,
        Clever: 0,
        damageReduction: 0,
        heartyHeal: false,
        luckyTriggered: false
    };
    if (b.includes("Muscled"))
        bonuses.Strong += Math.floor(adv.hp / 4);
    if (b.includes("Wizard")) {
        bonuses.Clever += 3;
        if(adv.Strong>=2) bonuses.Strong -= 2;
        else bonuses.Strong -= adv.Strong;
    }
    if (b.includes("Warrior")) {
        bonuses.Strong += 3;
        if(adv.Clever>=2) bonuses.Clever -= 2;
        else bonuses.Clever -= adv.Clever;
    }
    if (b.includes("Scholar")) {
        const hasArtifact = document.querySelector(".card-btn.sparkling") !== null;
        if (hasArtifact) bonuses.Clever += 2;
    }
    if (b.includes("Collector")) {
        const cards = document.querySelectorAll(".card-btn");
        let found = false;
        cards.forEach(c => {
            const s = Number(c.dataset.stars || 1);
            if (s >= 3) found = true;
        });
        if (found) bonuses.Strong += 2;
    }
    if (b.includes("Lucky")) {
        const cards = document.querySelectorAll(".card-btn.encounter-card");
        let lethal = false;

        cards.forEach(btn => {
            const stars = Number(btn.dataset.stars);
            // New condition: threat if stars >= your current HP
            if (stars >= adv.hp) lethal = true;
        });

        if (lethal) {
            bonuses.Strong += 2;
            bonuses.Clever += 2;
            bonuses.luckyTriggered = true;
        }
    }
    if (b.includes("Armored")) bonuses.damageReduction = 1;
    if (b.includes("Thrill-seeker") && adv.hp <= 1.5) bonuses.Strong += 6;
    if (b.includes("All-rounder")) {
        if (adv.Strong === 0) bonuses.Strong += 2;
        if (adv.Clever === 0) bonuses.Clever += 2;
    }
    return bonuses;
}


// ----------------------------------------------------
// Modals (restart)
// ----------------------------------------------------
function openNewGameModal() {
    document.getElementById("modal-newgame").classList.add("show");
}
function closeNewGameModal() {
    document.getElementById("modal-newgame").classList.remove("show");
}
function confirmNewGame() {
    logLines = [];
    saveGame();
    location.reload();
}
function forceNewGame() {
    logLines = [];
    saveGame();
    document.getElementById("continue-btn").style.display = "none";
    location.reload();
}

// ----------------------------------------------------
// Random initial state
// ----------------------------------------------------

const allTraits = [
    "Muscled", "Scholar", "Collector", "Glutton", "Gambler",
    "Lucky", "Armored", "Thrill-seeker", "All-rounder", 
    "Pestered", "Wizard"
];
function createNewAdventurer() {
    const traits = [];
    while (traits.length < 2) {
        const t = allTraits[Math.floor(Math.random() * allTraits.length)];
        if (!traits.includes(t)) traits.push(t);
    }

    return {
        hp: 4 + Math.round(Math.random() * 2),
        Strong: Math.round(Math.random() * 5),
        Tough: 0,
        Clever: Math.round(Math.random() * 5),
        Talent: Math.round(Math.random() * 5) + 3,
        Adventure: 1,
        Backgrounds: traits
    };
}

function showFloatingMessage(html) {
    const blocks = html.split("<hr>");
    const fm = document.getElementById("floatingMessage");
    const ov = document.getElementById("floatingOverlay");

    let blockIndex = 0;
    let lineIndex = 0;
    let lines = [];

    fm.classList.add("show");
    ov.classList.add("show");
    fm.innerHTML = "";

    function showNextLine() {
        // Move to next block
        if (lineIndex >= lines.length) {
            blockIndex++;
            if (blockIndex >= blocks.length) {
                setTimeout(() => {
                    fm.classList.remove("show");
                    ov.classList.remove("show");
                    document.querySelectorAll(".card-btn").forEach(c => {c.classList.add("card-fade-out");});
                }, 0);
                setTimeout(() => endOfTurn(), 400);
                return;
            }
            lines = blocks[blockIndex].split("<br>");
            lineIndex = 0;
            fm.innerHTML = "";
        }

        const line = document.createElement("div");
        if(lineIndex)
            line.className = "floating-text";
        line.innerHTML = lines[lineIndex++];
        fm.appendChild(line);
        setTimeout(showNextLine, 1100);
    }

    lines = blocks[0].split("<br>");
    showNextLine();
}



let adv = createNewAdventurer();
adv.Tough = adv.hp;

// NEW FLAG
let statlessMode = false;

if (!loadGame()) {
    adv = createNewAdventurer();
    adv.Tough = adv.hp;
    statlessMode = false;
}

// ----------------------------------------------------
// Stats UI
// ----------------------------------------------------
function updateStats() {
    if (adv.hp < 0) adv.hp = 0;
    if (adv.Tough < 0) adv.Tough = 0;
    if (adv.hp > adv.Tough) adv.hp = adv.Tough;

    const grey = Math.max(adv.Tough - adv.hp, 0);


    if (statlessMode) {
        document.getElementById("stats").innerHTML = `
            <div class="stat-block">&nbsp;<br>
                ${"‚ù§Ô∏è".repeat(adv.hp)}${"ü©∂".repeat(grey)}<br>
                ${adv.Adventure}${stars(1)}<br>&nbsp;
            </div>
        `;
        document.getElementById("adventureDisplay").style.display = "none";
        return;
    }

        document.getElementById("adventureDisplay").style.display = "inline";
    document.getElementById("adventureDisplay").innerHTML =
        `<span style="position:relative;display:inline-block;font-size:62px;margin-left:30px;margin-right:30px;margin-top:4px;">
            <span style="position:absolute;inset:50% auto auto 50%;transform:translate(-50%,-50%);opacity:0.8;z-index:0;">
                ${stars(1,72)}
            </span>
            <span style="position:relative;z-index:1;font-size:42px;left:-4px;top:-10px;color:white;text-align:center;width:62px;">
                ${adv.Adventure}
            </span>
        </span>`;


    // --- hunter check ---
    const encountersNow = [...document.querySelectorAll(".card-btn.encounter-card")];

    let StrongRelevant = false;
    let CleverRelevant = false;

    encountersNow.forEach(btn => {
        const html = btn.innerHTML;
        if (html.includes("Strong")) StrongRelevant = true;
        if (html.includes("Clever")) CleverRelevant = true;
    });

    const hunterHas = adv.Backgrounds && adv.Backgrounds.includes("Hunter");

    // Trait display
    const traitList = adv.Backgrounds || [];
    let strTraitIcons = "";
    let thinkTraitIcons = "";
    if (traitList.includes("Wizard")) {
        if(adv.Strong) strTraitIcons += "‚ùå".repeat(Math.min(2, adv.Strong))+" Wizard <span style='color:#666'>trait weakens this</span>";
    }
    if (traitList.includes("Warrior")) {
        if(adv.Clever) thinkTraitIcons += "‚ùå".repeat(Math.min(2, adv.Clever))+" Warrior <span style='color:#666'>trait weakens this</span>";
    }
    if (traitList.includes("Wizard")) thinkTraitIcons += "+" + "üß†".repeat(3)+" Wizard <span style='color:#666'>trait</span>";
    if (traitList.includes("Warrior")) strTraitIcons += " + " + "üí™".repeat(3)+" Warrior <span style='color:#666'>trait</span>";
    if (traitList.includes("Muscled") && adv.hp>4) strTraitIcons += " + " + "üí™".repeat(Math.floor(adv.hp / 4))+" Muscled <span style='color:#666'>trait based on HP</span>";
    if (traitList.includes("Collector")) {
        let rarityBoost = false;
        document.querySelectorAll(".card-btn").forEach(btn => { if (Number(btn.dataset.stars) >=3 ) rarityBoost = true;});
        if (rarityBoost) strTraitIcons += " + üí™üí™ Collector <span style='color:#666'>trait sees a rare card</span>";
    }
    if (traitList.includes("Lucky")) {
        let luckyActive = false;
        document.querySelectorAll(".card-btn.encounter-card").forEach(btn => {
            if (Number(btn.dataset.stars) >= adv.hp) luckyActive = true;
        });
        if (luckyActive) strTraitIcons += " + üí™üí™ Lucky <span style='color:#666'>trait sees a lethal threat</span>";
        if (luckyActive) thinkTraitIcons += " + üß†üß† Lucky <span style='color:#666'>trait sees a lethal threat</span>";
    }
    if (traitList.includes("Thrill-seeker") && adv.hp <= 1.5) strTraitIcons += " + üí™üí™üí™üí™üí™üí™ Thrill-seeker <span style='color:#666'>trait at one HP</span>";
    if (traitList.includes("Scholar")) {
        const hasArtifact = document.querySelector(".card-btn.sparkling") !== null;
        if (hasArtifact) thinkTraitIcons += " + üß†üß† Scholar <span style='color:#666'>trait sees an artifact</span>";
    }
    if (traitList.includes("All-rounder")) {
        if (adv.Strong === 0) strTraitIcons += " + üí™üí™ All-rounder <span style='color:#666'>trait at zero stats</span>";
        if (adv.Clever === 0) thinkTraitIcons += " + üß†üß† All-rounder <span style='color:#666'>trait at zero stats</span>";
    }

    document.getElementById("stats").innerHTML = `
        <table class="stat-table">

            <!-- HP / Tough -->
            <tr>
                <td>
                    HP / Tough&nbsp;&nbsp
                </td>
                <td>
                    ${"‚ù§Ô∏è".repeat(adv.hp)}${"ü©∂".repeat(Math.max(0, adv.Tough - adv.hp))}
                    ${traitList.includes("Armored") 
                    ? "+ üõ°Ô∏è Armored <span style='color:#666'>reduces >1 damage</span>" 
                    : ""}
                </td>
            </tr>
            <!-- Strong -->
            <tr>
                <td>
                    Strong 
                    ${hunterHas && !StrongRelevant ? "" : ""}
                </td>
                <td>
                    ${"üí™".repeat(Math.max(0, Math.floor(adv.Strong-(traitList.includes("Wizard")?2:0))))}
                    ${strTraitIcons}
                </td>
            </tr>

            <!-- Clever -->
            <tr>
                <td>
                    Clever 
                    ${hunterHas && !CleverRelevant ? "" : ""}
                </td>
                <td>
                    ${"üß†".repeat(Math.max(0, Math.floor(adv.Clever-(traitList.includes("Warrior")?2:0))))}
                    ${thinkTraitIcons}
                </td>
            </tr>
        </table>
        `;
}

// ----------------------------------------------------
function log(msg) {
    logLines.push(msg);
    if (logLines.length > 200) logLines.shift();
}

function logEvent(icon, msg, short_msg) {
    const full = `${icon} ${msg}`;
    logLines.push(full);
    if (logLines.length > 200) logLines.shift();
    showFloatingMessage(short_msg);
}

// ----------------------------------------------------
function rand() {
    return Math.random();
}

// ----------------------------------------------------
function d20() {
    return Math.floor(Math.random() * 20) + 1;
}

// ----------------------------------------------------
function stars(n, size=18) {
    const svg = `
        <svg viewBox="0 0 24 24" width="${size}" height="${size}" 
             fill="#f7d343" stroke="#c8a200" stroke-width="1.2"
             style="vertical-align: -3px; margin-right: 0px; margin-left: -10px">
            <polygon points="12,2 15.2,9 22.5,9 16.7,13.8 
                             18.9,21 12,16.8 5.1,21 7.3,13.8 
                             1.5,9 8.8,9"/>
        </svg>`;
    return svg.repeat(n);
}

function encounterIntensity(dc) {
    if (dc <= 12) return 1;
    if (dc <= 15) return 2;
    if (dc <= 17) return 3;
    return 4;
}

function logTailIncludes(str, count) {
    let start = Math.max(0, logLines.length - count);
    for (let i = start; i < logLines.length; i++) 
        if (logLines[i].includes(str)) return true;
    return false;
}

function countInLastLines(patterns, countLines) {
    let start = Math.max(0, logLines.length - countLines);
    let total = 0;
    for (let i = start; i < logLines.length; i++)
        for (const p of patterns) if (logLines[i].includes(p)) total++;
    return total;
}


// ----------------------------------------------------
// Card Definitions
// ----------------------------------------------------

const encounters = [
    { 
        name:"Ratswarm", icon:"üêÄüêÄ", stat:"Strong/Clever", dc:10,
        flavor:"A wave of panicked rodents rushes past and over you." 
    },

    { 
        name:"Stoneback", icon:"üê¢", stat:"Strong", dc:13,
        flavor:"A turtle the size of a cart blocks the way. Push it away." 
    },

    { 
        name:"Wildroot", icon:"üåø", stat:"Strong", dc:14,
        flavor:"A plant grabs your ankle! Resist its pull." },

    { 
        name:"Goblin Lurker", icon:"üë∫", stat:"Strong/Clever", dc:11,
        flavor:"A sneering goblin watches with bright yellow eyes." 
    },

    { 
        name:"Bandits", icon:"ü™ì", stat:"Strong/Clever", dc:12,
        flavor:"Their axes glint threateningly. Their heads even more." 
    },

    { 
        name:"Hex Tosser", icon:"üß®", stat:"Clever", dc:14,
        flavor:"The goblin rattles bones and hurls sparks all around." 
    },

    { 
        name:"Mystic Obelisk", icon:"üîÆ", stat:"Clever", dc:10,
        flavor:"It hums while freezing the air. Strength means nothing." 
    },

    { 
        name:"Thin Chasm", icon:"ü™®", stat:"Strong", dc:16,
        flavor:"Not only is the dust annoying, piles of stone collapse above." 
    },

    { 
        name:"Duelist", icon:"‚öîÔ∏è", stat:"Strong/Clever", dc:17,
        flavor:"A masked warrior challenges you without a word." 
    },

    { 
        name:"Stram", icon:"üêè", stat:"Clever", dc:20,
        flavor:"Cackling with a storm's static. Only hexes can tame this ram.",
        condition: () => {return logTailIncludes("Hex", 3);}
    },

    { 
        name:"Pestered", icon:"üåÄ", stat:"Strong/Clever", dc:15,
        flavor:"It would be too simple without the arch-nemesis showing up.",
        condition: () => {return false;},
        condition_description: "From pestered trait."
    },

    { 
        name:"May-maze", icon:"üåÄ", stat:"Clever", dc:18,
        flavor:"Illusory corridors whisper riddles of how to leave." 
    },

    { 
        name:"Sentinel", icon:"üå≥", stat:"Strong", dc:19,
        flavor:"Roots twist, branches whip the air. No thinking can save you.",
        condition: () => {return logTailIncludes("Wildroot", 3);}
    },

    { 
        name:"Trick Phantom", icon:"üëª", stat:"Clever", dc:12,
        flavor:"A translucent figure bends reality into clever traps." 
    },

    { 
        name:"Dragon", icon:"üêâ", stat:"Strong/Clever", dc:22,
        flavor:"Dreams of fire and destruction. It strives to make these real." 
    },

    { 
        name:"Hulky", icon:"üëπ", stat:"Strong/Clever", dc:19,
        flavor:"An ogre smashes the ground as it charges." 
    },

    { 
        name:"Boar Charge", icon:"üêó", stat:"Strong", dc:15,
        flavor:"Two tusks barrel forward. Only thought: yummy if roasted." 
    }

];


const trainings = [
    { 
        name:"Powerlifting", icon:"üèãÔ∏è", from:"Clever", to:"Strong",
        difficulty:1,
        flavor:"Muscles strain as you push past your limits." 
    },

    { 
        name:"Meditate", icon:"üßò", from:"Strong", to:"Clever",
        difficulty:1,
        flavor:"Breath, focus, and calm reshape your inner thoughts." 
    },

    {
        name:"Run Laps", icon:"üèÉ", from:"Strong", to:"Tough",
        difficulty:1,
        flavor:"Push your body through relentless repetition."//,condition: () => {return adv.Tough<=4 && adv.Strong>=1 && logTailIncludes("damage", 1);}
    },

    { 
        name:"Martial Way", icon:"ü•ã", from:"Tough", to:"Strong",
        difficulty:2,
        flavor:"Training ends when it should. Not when I'm tired.",
        condition: () => {return adv.Tough>=4 && logTailIncludes("Victory!", 1);},
    },

    { 
        name:"Puzzle Course", icon:"üß©", from:"Tough", to:"Clever",
        difficulty:2,
        flavor:"Patterns unfold everywhere. Focus." 
    },

    {
        name:"Reflection",
        icon:"üìø",
        from:"Talent",
        to:"Clever",
        difficulty:3,
        flavor:"You are quite clever, now that you think about it.",
        condition: () => {return logTailIncludes("Clever", 2);}
    },

    {
        name:"Strongman", icon:"üíÉ", from:"Talent", to:"Strong",
        difficulty:1,
        flavor:"Your biceps want to join the conversation about talents!",
        condition: () => {return logTailIncludes("Clever", 1) || logTailIncludes("Tough", 1) || logTailIncludes("Talent", 1);}
    },

    { 
        name:"Powerdance", icon:"üíÉ", from:"Talent", to:"Strong",
        difficulty:2,
        flavor:"Victory was thanks to a new movement technique!",
        condition: () => {return adv.Clever>=2 && logTailIncludes("Victory!", 1);}
    },

    { 
        name:"Balance", icon:"‚öñÔ∏è", from:"Clever", to:"Muscled trait",
        difficulty:3,
        flavor:"THis is your problem: Don't think, feel!",
        condition: () => {return adv.Clever>=5 && !logTailIncludes("Victory!", 3) && adv.Backgrounds.length<=2;} 
    },

    { 
        name:"Survivor", icon:"ü•ä", from:"Talent", to:"Tough",
        difficulty:3,
        flavor:"Every bruise has made you tougher. And it hurts.",
        condition: () => adv.hp < adv.Tough-2},

    { 
        name:"Grit Teeth", icon:"ü¶∑", from:"Talent", to:"Strong",
        difficulty:2,
        flavor:"There's always a last push. And one after. And another." ,
        condition: () => {return countInLastLines(["damage", "Victory!"], 3) >= 3;}
    },

    { 
        name:"Magiciano", icon:"üé©", from:"Talent", to:"Clever",
        difficulty:2,
        flavor:"Where's my hat? No, that's the rabbit. IT ATE THE HAT!"
    },

    { 
        name:"Wizardry", icon:"üßô‚Äç‚ôÇÔ∏è", from:"Talent", to:"Wizard trait",
        difficulty:3,
        flavor:"Say, fought a dragon recently? You have developed mana.",
        condition: () => {return logTailIncludes("Dragon", 3);}
    },

    { 
        name:"Clumsy God", icon:"ü§ï", from:"Trait", to:"Talent",
        difficulty:3,
        flavor:"Failing too much recently? Sooory...",
        condition: () => {return adv.Backgrounds.length&&countInLastLines(["difficult","damage"],5)>=3;}
    },

    {
        name:"Temptation", icon:"üòà", from:"Trait", to:"Trait",
        difficulty:2,
        flavor:"I don't know who I am. Do YOU know who you are?",
        condition: () => {return adv.Backgrounds.length&&countInLastLines(["difficult","damage"],4)>=2;}
    }

];

const treasures = [
    { 
        name:"Authority", icon:"üëë",
        difficulty:3, cost:{Clever:2}, heal:3, adventure:0,
        flavor:"A faded memory of royalty stirs inside." 
    },

    { 
        name:"Titanbone Idol", icon:"üóø",
        difficulty:1, cost:{Strong:2}, heal:3, adventure:0,
        flavor:"Its echoing prayer aids the strong." 
    },

    { 
        name:"Fire Feather", icon:"üî•",
        difficulty:1, cost:{Tough:1}, heal:4, adventure:0,
        flavor:"Magic echoes draws you to a source of warm healing.",
        condition: () => {return adv.hp<adv.Tough-3 && adv.Clever>=4;}
    },

    { 
        name:"Clockwork", icon:"‚öôÔ∏è",
        difficulty:4, cost:{Clever:2, Strong:2}, heal:0, adventure:0,
        flavor:"Springs and gears mesmerize you." 
    },

    { 
        name:"Mealtime", icon:"üè∫",
        difficulty:0, cost:{}, heal:1, adventure:0,
        flavor:"What you defeated looks yummy! Enjoy a meal.",
        condition_priority: 20,
        condition: () => {return logTailIncludes("Victory!", 1)&&logTailIncludes("Boar", 1)&&adv.hp<adv.Tough;}
    },

    { 
        name:"Mealtime", icon:"üè∫",
        difficulty:0, cost:{}, heal:1, adventure:0,
        flavor:"You found some ingredients! Enjoy a meal.",
        condition_priority: 10,
        condition: () => {return logTailIncludes("Victory!", 1)&&adv.Backgrounds.includes("Glutton")&&adv.hp<adv.Tough;},
        condition_description: "From glutton trait."
    },

    { 
        name:"Deep Drink", icon:"üè∫",
        difficulty:0, cost:{Clever:1}, heal:2, adventure:-4,
        flavor:"A sip restores vitality as if from endless waters.",
        condition: () => {return adv.Adventure>4 && adv.hp<3;}},

    { 
        name:"Orb of Bleak", icon:"üßø",
        difficulty:0, cost:{}, heal:4, adventure:-8,
        flavor:"Life is more precious than glory. Say the glorious.",
        condition: () => {return adv.Adventure>5 && !logTailIncludes("Victory", 3);}
    },

    { 
        name:"Frostbite", icon:"‚ùÑÔ∏è",
        difficulty:5, cost:{Clever:2}, heal:-2, adventure:0,
        flavor:"Sudden frost steals away warmth, thought, and resolve.",
        condition_priority: 100,
        condition: () => {return logTailIncludes("Obelisk", 2);}
    },

    { 
        name:"Shright", icon:"üçÑ",
        difficulty:7, cost:{}, heal:-3, adventure:0,
        flavor:"Your skin will sprout spores. A staple of rats and goblins.",
        condition_priority: 100,
        condition: () => {return logTailIncludes("Ratswarm", 2) || logTailIncludes("Goblin", 2) || logTailIncludes("Hex", 2);}
    },

    { 
        name:"Desert Lily", icon:"üèúÔ∏è",
        difficulty:1, cost:{Strong:4}, heal:4, adventure:0,
        flavor:"Shifting sand drains stamina, protecting."
    },

    { 
        name:"Treasure", icon:"üèúÔ∏è",
        difficulty:3, cost:{}, heal:0, adventure:0,
        flavor:"You discover shiny treasure in the last encounter's lair.",
        condition_priority: 20,
        condition: () => {return logTailIncludes("Victory!", 1)&&(logTailIncludes("Bandit", 1) || logTailIncludes("Dragon", 1));}
    },

    { 
        name:"Gambler", icon:"üé≤",
        difficulty:1, cost:{}, heal:0, adventure:0,
        flavor:"You like extreme die rolls. Just had one!",
        condition_priority: 200,
        condition: () => {return (logTailIncludes("roll 1:", 1) || logTailIncludes("roll 20:", 1)) && adv.Backgrounds.includes("Gambler");},
        condition_description: "From gambler trait."
    },

    { 
        name:"Primalt", icon:"üßø",
        difficulty:6, cost:{}, heal:0, adventure:0,
        flavor:"Sometimes found near the lair of old powers.",
        condition_priority: 100,
        condition: () => {return (logTailIncludes("Stram", 1) || logTailIncludes("Dragon", 1) || logTailIncludes("Sentinel", 1) || logTailIncludes("May-maze", 1));}
    }
];

// ----------------------------------------------------
// Card Rendering
// ----------------------------------------------------
function iconUrl(name) {
    const file = name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
    // https://raw.githubusercontent.com/maniospas/mini-adventure/main/img/${file}.png
    return `img/${file}.png`;
}

function imageBox(icon, name, entry_type) {
    const url = iconUrl(name);
    const encounterBg = iconUrl(entry_type)

    return `
        <div style="position:relative;height:120px;border:1px solid black;background:#ddd;overflow:hidden;">
            <img src="${encounterBg}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0.8;">
            <img src="${url}"
                 onerror="this.onerror=null; this.replaceWith(document.createTextNode('${icon}'))"
                 style="position:relative;width:100%;height:100%;object-fit:contain;z-index:1;">
        </div>
    `;
}

const imageFiles = [];
encounters.forEach(c => {
    const file = c.name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
    imageFiles.push(`img/${file}.png`);
});
trainings.forEach(c => {
    const file = c.name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
    imageFiles.push(`img/${file}.png`);
});
treasures.forEach(c => {
    const file = c.name.toLowerCase().replace(/[^a-z0-9]+/g, "_");
    imageFiles.push(`img/${file}.png`);
});
imageFiles.push("img/enc.png", "img/train.png", "img/treas.png");


function cardButtonHTML(entry) {
    const c = entry.card;

    // Fixed height wrappers
    const titleBox = (str,type) => `<div style="height:35px; font-size:1.4em;text-align:left;padding-left:5px"><b>${str}</b><div style="float:right">${type}</div></div>`;
    const infoBox  = html => `<div style="height:30px; display:flex; align-items:center; justify-content:center; flex-direction:column; padding-top:10px;">${html}</div>`;
    const flavorBox = txt => `<div style="height:30px; font-size:0.9em; opacity:0.7; display:flex; align-items:center; text-align:left;">${txt}</div>`;
    const conditional = c.condition?`<div style="color:#640;height:30px"><b>${c.condition_description?c.condition_description:""}</b></div>`:'<div style="height:30px"></div>';
    // -------------------------
    // ENCOUNTER
    // -------------------------
    if (entry.type === "enc") {
        const i = encounterIntensity(c.dc);
        const info = `<div><span style="color:#822">Damage</span> or üèîÔ∏è determined by your state and its rarity.</div>`;
        return `
            ${titleBox(c.name, `${stars(i)}`)}
            ${imageBox(c.icon, c.name, entry.type)}
            ${infoBox(`&nbsp;<br>${dresult('?', 50)}`)}
            ${conditional}
            ${flavorBox(c.flavor)}
        `;
    }
    if (entry.type === "train") {
        const info = c.from?`<div><b>${c.from} ‚Üí ${c.to}</b></div>`:`<div><b>Gain ${c.to}</b></div>`;
        return `
            ${titleBox(c.name, `${stars(c.difficulty)}`)}
            ${imageBox(c.icon, c.name, entry.type)}
            ${infoBox(info)}
            ${conditional}
            ${flavorBox(c.flavor)}
        `;
    }
    if (entry.type === "treas") {
        let effects = c.cost && Object.keys(c.cost).length?`${Object.keys(c.cost).join(", ")}`:"";
        if (c.adventure < 0) {
            if(effects) effects += ", ";
            effects += "&nbsp;"+stars(-c.adventure, 18);
        }
        if (c.heal < 0) {
            if(effects) effects += ", ";
            effects += '‚ù§Ô∏è'.repeat(-c.heal);
        }
        let rhs_effects = "";
        if (c.heal > 0) rhs_effects += '‚ù§Ô∏è'.repeat(c.heal);
        if (c.adventure > 0) rhs_effects += "&nbsp;"+stars(c.adventure, 18);
        // if (c.cost && Object.keys(c.cost).length) {
        //     if(rhs_effects) rhs_effects += ", ";
        //     rhs_effects += "Talent";
        // }
        if (effects || rhs_effects) {
            if (!effects) effects = "always";
            if (!rhs_effects) rhs_effects = "nothing";
            effects += " ‚Üí "+rhs_effects;
        }
        const info = `<div><b>${effects}</b></div>`;
        return `
            ${titleBox(c.name, `${stars(c.difficulty)}`)}
            ${imageBox(c.icon, c.name, entry.type)}
            ${infoBox(info)}
            ${conditional}
            ${flavorBox(c.flavor)}
        `;
    }
}

function animateCardSelection(btn, effectText, callback) {
    const rect = btn.getBoundingClientRect();

    // Freeze geometry
    btn.style.transform = "translateX(0) scale(1)";
    btn.style.willChange = "transform";
    btn.style.zIndex = "9500";

    // Force layout
    btn.offsetHeight;

    // Fade others
    document.querySelectorAll(".card-btn").forEach(c => {
        if (c !== btn) c.classList.add("card-fade-out");
    });

    function getScaleX(el) {
        const m = window.getComputedStyle(el).transform;
        if (m === "none") return 1;
        const values = m.match(/matrix\(([^)]+)\)/)[1].split(",");
        return parseFloat(values[0]); // scaleX
    }

    // Compute delta instead of absolute left
    const scaleX = getScaleX(document.getElementById("choices"));
    const visualLeft = rect.left;
    const unscaledLeft = visualLeft / scaleX;

    const targetX = 20; // viewport px
    const deltaX = targetX - unscaledLeft + 20;

    btn.style.transition = "transform 0.45s ease";
    btn.style.transform = `translateX(${deltaX}px) scale(1)`;

    setTimeout(callback, 1000);
}



function pickRandomAllowed(list) {
    const allowed = list.filter(c =>!c.condition || c.condition(adv));
    if (allowed.length === 0) return null;
    const weights = allowed.map(c => {
        let stars = 1;
        if (c.dc !== undefined) stars = encounterIntensity(c.dc);
        if (c.difficulty !== undefined) stars = c.difficulty;
        let base = c.dc ? Math.min(1, adv.Strong / c.dc) : 1;
        if (c.condition && !logTailIncludes(c.name, 5)) base *= 128*(c.condition_priority?c.condition_priority:1);
        return base / Math.pow(2, Math.max(0, stars-adv.Adventure/10));
    });
    const total = weights.reduce((a, b) => a + b, 0);
    let r = Math.random() * total;
    for (let i = 0; i < allowed.length; i++) {
        r -= weights[i];
        if (r < 0) return allowed[i];
    }
    return allowed[allowed.length - 1]; //
}


function generateChoices() {
    if (adv.hp <= 0) return;
    if (adv.Adventure <= 0) return;
    const choiceBox = document.getElementById("choices");
    choiceBox.innerHTML = "";
    let pool = [
        {type:"enc",   card: pickRandomAllowed(encounters)},
        {type:"enc",   card: pickRandomAllowed(encounters)},
        {type:"enc",   card: pickRandomAllowed(encounters)},
        {type:"train", card: pickRandomAllowed(trainings)},
        {type:"train", card: pickRandomAllowed(trainings)},
        {type:"treas", card: pickRandomAllowed(treasures)},
        {type:"treas", card: pickRandomAllowed(treasures)},
    ];

    // keep random
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    shuffle(pool);

    // remove duplicates
    const seen = new Set();
    let has_seen_conditional = false;
    pool = pool.filter(p => {
        const key = p.card.name;
        if (p.card.condition) {
            if(has_seen_conditional) return false;
            has_seen_conditional = true;
        }
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
    });

    // select actual options
    if(Math.random()<0.2 && adv.Adventure>5) pool = pool.slice(0,1);
    else if(Math.random()<0.4 && adv.Adventure>5) pool = pool.slice(0,2);
    else pool = pool.slice(0,3);

    // apply pestered trait with 80% chance
    if (pool.length < 2 && adv.Backgrounds.includes("Pestered") && Math.random() < 0.8) {
        const pestered = encounters.find(e => e.name === "Pestered");
        if (pestered) pool.push({ type: "enc", card: pestered });
    }

    // create cards
    pool.forEach(entry => {
        encounteredCards.add(entry.card.name);
        const btn = document.createElement("button");
        btn.className = "card-btn";
        if (entry.type === "enc") {
            const diff = encounterIntensity(entry.card.dc);
            btn.classList.add("encounter-card", "encounter-diff-" + (diff>4?4:diff));
        }
        btn.innerHTML = cardButtonHTML(entry);
        if (entry.type === "enc")   btn.onclick = () => {animateCardSelection(btn, "", () => playEncounter(entry.card));};
        if (entry.type === "train") btn.onclick = () => {animateCardSelection(btn, "", () => playTraining(entry.card));};
        if (entry.type === "treas") btn.onclick = () => {animateCardSelection(btn, "", () => playTreasure(entry.card));};
        btn.dataset.stars = (entry.type === "enc")?encounterIntensity(entry.card.dc):(entry.type === "train")? entry.card.difficulty:entry.card.difficulty;
        //if (entry.type === "treas") btn.classList.add("sparkling");
        choiceBox.appendChild(btn);
    });
}

function pickBestStat(statString, bonuses) {
    const stats = statString.split("/");
    let best = null;
    let bestVal = -Infinity;

    for (const s of stats) {
        const stat = s.trim();
        let bonus = 0;

        // add stat-specific bonus
        if (stat === "Strong") bonus = bonuses.Strong || 0;
        if (stat === "Clever") bonus = bonuses.Clever || 0;

        const total = adv[stat] + bonus;

        if (total > bestVal) {
            best = stat;
            bestVal = total;
        }
    }

    return best;
}

function dresult(roll, height=120) {
    return `<span style="position:relative;display:inline-block;"><img src="img/d20.png" style="height:${height}px;margin:10px;display:block;"><span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:bold;pointer-events:none;color:#1f1f1f;">${roll}</span></span>`;
}

function playEncounter(c) {
    const bonuses = getTraitBonuses();

    let stat = pickBestStat(c.stat, bonuses);
    const roll = d20();

    let bonus = 0;
    let stat_value = "<br>No stat bonus.";
    if (stat === "Strong") {
        bonus += bonuses.Strong || 0;
        if(adv[stat]+bonus>0) stat_value = "<br>+"+"üí™".repeat(adv[stat]+bonus);
    }
    if (stat === "Clever") {
        bonus += bonuses.Clever || 0;
        if(adv[stat]+bonus>0) stat_value = "<br>+"+"üß†".repeat(adv[stat]+bonus);
    }
    //bonus += 3; // this value here serves as DIFFICULTY ADJUSTMENT (it is added to player rolls)
    const enemy_roll = 10;//d20(); 
    const is_critical_damage = roll==1||enemy_roll==20;
    const is_critical_gain = roll==20||enemy_roll==1;
    const total = is_critical_damage? 1: (roll + adv[stat] + bonus);
    if(is_critical_damage)
        stat_value = '<br><span style="color:red;">Disastrous failure.</span>';
    if(is_critical_gain)
        stat_value = '<br><span style="color:#ddffdd;">Overwhelming success.</span>';

    const difficulty = encounterIntensity(c.dc);

    if (total > (c.dc-10)/2+enemy_roll || is_critical_gain) {
        adv.Adventure += difficulty;
        logEvent(
            c.icon,
            `${c.name} vs your roll ${roll}: Victory! +${difficulty} üèîÔ∏è.`,
            `<div style="margin-bottom:14px;">Rolling for your win...</div><br><div style="margin-top:14px;margin-bottom:14px;align-items:center;justify-content:center;">${dresult(roll)}</div>${stat_value}<hr><div style="height:90px;align-items:center;justify-content:center;"><div style="font-size:42px;margin-top:94px;margin-bottom:34px">Victory!</div></div>`
        );
    } 
    else {
        let dmg = is_critical_damage?difficulty:(1 + Math.floor(difficulty * Math.random()));
        if (bonuses.damageReduction && dmg > 1.5) dmg -= 1;
        adv.hp -= dmg;
        logEvent(
            c.icon,
            `${c.name} vs your roll ${roll}: <span style="color:#f44">${dmg} damage.</span>`,
            `<div style="margin-bottom:14px;">Rolling for your win...</div><br><div style="margin-top:14px;margin-bottom:14px;align-items:center;justify-content:center;">${dresult(roll)}</div>${stat_value}<hr><div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Took ${dmg} damage.</div>`
        );
    }
}


function playTraining(c) {
    let from = c.from;
    let to = c.to;
    const movement = c.from=="Talent"?c.difficulty:Math.round(rand()*Math.max(c.difficulty, 0));
    if (typeof from === "string" && from.endsWith(" trait")) {
        const lost  = from.slice(0, -6);  // remove " trait"
        if (adv.Backgrounds && adv.Backgrounds.length > 0) {
            const idx = adv.Backgrounds.indexOf(lost);
            if (idx !== -1) adv.Backgrounds.splice(idx, 1);
            else {
                logEvent(
                    c.icon,
                    `${c.name}: <span style="color:#f44">Too difficult today (you don't meet the criteria).</span>`,
                    `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
                );
                return;
            }
        }
    }
    else if (from=="Trait") {
        if (!adv.Backgrounds || adv.Backgrounds.length === 0) {
            adv.Adventure -= c.difficulty;
            logEvent(
                c.icon,
                `${c.name}: <span style="color:#f44">Too difficult today (no traits left).</span>`,
                `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
            );
            return;
        }
        const idx = Math.floor(Math.random() * adv.Backgrounds.length);
        const lost = adv.Backgrounds.splice(idx, 1)[0];
        from = lost+" trait";
    }
    else if (adv[c.from] <= c.difficulty) {
        adv.Adventure -= c.difficulty;
        logEvent(c.icon, 
            `${c.name}: <span style="color:#f44">Too difficult today.</span>`, 
            `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
        );
        return;
    }
    else {
        if(from=="Tough") from = "ü©∂".repeat(c.difficulty);
        else if(from=="Strong") from = "üí™".repeat(c.difficulty);
        else if(from=="Clever") from = "üß†".repeat(c.difficulty);
        else from = `${from}`;
        adv[c.from] -= c.difficulty;
    }
    if (typeof to === "string" && to.endsWith(" trait")) {
        if (!adv.Backgrounds || adv.Backgrounds.length >= 3) {
            adv.Adventure -= c.difficulty;
            logEvent(
                c.icon,
                `${c.name}: <span style="color:#f44">Too difficult today (trait limit).</span>`,
                `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
            );
            return;
        }
        const gained = to.slice(0, -6); // remove " trait" to get the background name
        if (!adv.Backgrounds) adv.Backgrounds = [];
        if (!adv.Backgrounds.includes(gained)) adv.Backgrounds.push(gained);
        else console.warn(`Tried to add background "${gained}" because it's already present.`);
        to += " gained";
    }
    else if (to == "Trait") {
        if (!adv.Backgrounds || adv.Backgrounds.length >= 3) {
            adv.Adventure -= c.difficulty;
            logEvent(
                c.icon,
                `${c.name}: <span style="color:#f44">Too difficult today (trait limit).</span>`,
                `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
            );
            return;
        }
        const available = allTraits.filter(t => !adv.Backgrounds.includes(t));
        if (available.length === 0) {
            adv.Adventure -= c.difficulty;
            logEvent(
                c.icon,
                `${c.name}: <span style="color:#f44">Too difficult today (no traits left).</span>`,
                `<div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
            );
            return;
        }
        const newTrait = available[Math.floor(Math.random() * available.length)];
        adv.Backgrounds.push(newTrait);
        to = newTrait+" trait gained";
    }
    else {
        adv[to] += movement;
        adv.Talent += c.difficulty-movement;
        //if(movement==c.difficulty)
        adv.Adventure += c.difficulty;
        if(to=="Tough") to = "ü©∂".repeat(movement);
        else if(to=="Strong") to = "üí™".repeat(movement);
        else if(to=="Clever") to = "üß†".repeat(movement);
        else if(to!="Talent") to = `${to}`;
        if(movement==0) to = "nothing";
        to += "&nbsp;gained";
        if(movement<c.difficulty) 
            to += '<br><div style="color:#ddffdd; margin-top:20px; text-align: left; margin-left: 100px;">There\'s talent leftover!</div>';
            //to += `&nbsp;gained<br><hr><div style="font-size:42px;margin-top:64px;margin-bottom:34px">Perfect!</div>${stars(c.difficulty, 36)}`;
        //if(to=="Tough") adv.hp += movement;
    }
    logEvent(c.icon, `${c.name}: ${from} ‚Üí ${to}.`, `<div style="margin-top:2px;text-align:left;">${from}&nbsp;is consumed...</div><br><div style="margin-top:20px;text-align:left;margin-left:50px;">...${to}</div>`);
}

function playTreasure(c) {
    const reject = Math.floor(Math.pow(rand(), Math.max(0,5-c.difficulty)) * 5) + 1;
    let power = 100;
    let offering = "";
    for (let stat in c.cost)
        if(adv[stat]<power) {
            power = adv[stat];
            if(offering) offering += "<br>";
            offering += '<div style="text-align:left;margin-left:0px;">';
            if(stat=="Tough") offering += "ü©∂".repeat(reject)+" demanded...";
            else if(stat=="Strong") offering += "üí™".repeat(reject)+" demanded...";
            else if(stat=="Clever") offering += "üß†".repeat(reject)+" demanded...";
            else offering += " "+stat+" demanded..."; 
            offering += "</div>";
        }
    if(c.heal<0) {
        if(offering) offering += "<br>";
        offering += '<div style="text-align:left;margin-left:0px;">';
        offering += "‚ù§Ô∏è".repeat(-c.heal)+"&nbsp;demanded...</div>";
    }
    if(c.adventure<0) {
        if(offering) offering += "<br>";
        offering += '<div style="text-align:left;margin-left:0px;">';
        offering += stars(-c.adventure, 32)+"&nbsp;demanded...</div>";
    }
    if (reject > power) {
        adv.Adventure -= c.difficulty;
        logEvent(c.icon, 
            `${c.name} - <span style="color:#f44">It rejects you.</span>`, 
            `<div style="margin-top:2px;text-align:left;"></div>${offering}<hr><div style="height:90px;color:#f44;align-items:center;justify-content:center;margin-top:94px;margin-bottom:34px;font-size:42px;">Too difficult: lost&nbsp; ${stars(c.difficulty,36)}</div>`
        );
        return;
    }
    let granted = "";
    for (let stat in c.cost) {
        adv[stat] -= c.cost[stat];
        adv.Talent += c.cost[stat];
    }

    adv.hp += c.heal;
    if(c.heal>0) {
        if(granted || offering) granted += "<br>";
        granted += '<div style="text-align:left;margin-left:50px;">...';
        granted += "‚ù§Ô∏è".repeat(c.heal)+"&nbsp;gained</div>";
    }
    if (adv.hp > adv.Tough) adv.hp = adv.Tough;
    if (c.adventure>0) {
        if(granted || offering) granted += "<br>";
        granted += '<div style="text-align:left;margin-left:50px;">...';
        granted += stars(c.adventure, 32)+"&nbsp;extra</div>";
    }
    if(c.cost && Object.keys(c.cost).length) granted += '<br><div style="color:#ddffdd; margin-top:20px; text-align: left; margin-left: 100px;">There\'s talent leftover!</div>';
    adv.Adventure += c.adventure+c.difficulty;
    logEvent(c.icon, 
        `${c.name}: Accepted you.`, 
        (offering?`<div style="margin-top:2px;text-align:left;"></div>${offering}`:'')
        +`<div style="margin-top:-10px;text-align:left;margin-left:50px;">&nbsp;</div>${granted}`
    );
}

function getBestScore() {
    return Number(localStorage.getItem("tama_bestscore") || 0);
}

function setBestScore(score) {
    const best = getBestScore();
    if (score > best) localStorage.setItem("tama_bestscore", score);
}

function endOfTurn() {
    saveGame();
    if (adv.hp <= 0) {
        updateStats();
        const score = adv.Adventure;
        setBestScore(score);
        document.getElementById("death-score").innerHTML = `Score: ${score}&nbsp;${stars(1)}<br>Best: ${getBestScore()}&nbsp;${stars(1)}`;
        document.getElementById("modal-death").classList.add("show");
        return;
    }
    if (adv.Adventure <= 0) {
        adv.Adventure = 0;
        updateStats();
        const score = 0;
        setBestScore(score);
        document.getElementById("death-score-adv").innerHTML = `Your score is zero...<br>This is not fun anymore!`;
        document.getElementById("modal-death-adv").classList.add("show");
        return;
    }
    generateChoices();
    updateStats();
}

//generateChoices();
updateStats();
saveGame();

function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
    };
}

window.addEventListener("DOMContentLoaded", () => {
    const searchBox = document.getElementById("ledger-search");
    searchBox.addEventListener("input", debounce(buildLedgerList, 250));
});

window.addEventListener("DOMContentLoaded", () => {
    preloadImages(imageFiles, () => {
        console.log("All images preloaded.");
        generateChoices();
        updateStats();
        saveGame();
    });
});

</script>

<div id="floatingOverlay"></div>
<div id="floatingMessage"></div>

<!-- Ledger Screen -->
<div id="ledger-screen" style="
    position: fixed;
    inset: 0;
    background: #111;
    color: #eee;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    overflow-y: auto;
    z-index: 99998;
">
    <!--<h1 style="margin-bottom: 10px;">Ledger</h1>-->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <input id="ledger-search" placeholder="Search cards..." style="width: 90%; max-width: 400px; padding: 10px; margin: 0; border-radius: 6px; border: 1px solid #555; background: #111; color: #eee;" />
        <button onclick="closeLedger()" style="padding:10px 20px; border-radius:8px; margin-left: 10px; background:#333; color:#eee; border:1px solid #666;"> Back </button>
    </div>

    <div id="ledger-container"
        style="
            width: 90%;
            margin: 0 auto;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
        ">
        <div id="ledger-list"
            style="
                display: flex;
                flex-direction: row;
                gap: 20px;
                padding: 10px 5px;
                width: max-content;
                color: black;
            ">
        </div>
    </div>
</div>


</body>
</html>
